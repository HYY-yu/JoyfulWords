# 401 è‡ªåŠ¨è·³è½¬å®ç°è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å½“ access token è¿‡æœŸæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•åˆ·æ–° tokenã€‚å¦‚æœåˆ·æ–°æˆåŠŸï¼Œä¼šè‡ªåŠ¨é‡è¯•åŸè¯·æ±‚ï¼›å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µã€‚

## å®ç°ç»†èŠ‚

### 1. `apiRequest` å‡½æ•°å¢å¼º (lib/api/client.ts:74-139)

æ·»åŠ äº†ç¬¬ä¸‰ä¸ªå‚æ•° `skipAuthRefresh`ï¼š

```typescript
export async function apiRequest<T>(
  endpoint: string,
  options: RequestInit = {},
  skipAuthRefresh = false  // ğŸ”¥ æ–°å¢å‚æ•°
): Promise<T>
```

#### 401 å¤„ç†æµç¨‹

1. **æ”¶åˆ° 401 å“åº”** â†’ æ£€æŸ¥ `skipAuthRefresh` æ ‡å¿—
2. **å¦‚æœå…è®¸åˆ·æ–°** (`skipAuthRefresh = false`)ï¼š
   - è°ƒç”¨ `refreshAccessToken()` å°è¯•åˆ·æ–° token
   - **åˆ·æ–°æˆåŠŸ** â†’ ä½¿ç”¨æ–° token é‡è¯•åŸè¯·æ±‚
   - **åˆ·æ–°å¤±è´¥** â†’ é‡å®šå‘åˆ° `/auth/login?reason=token_expired`
3. **å¦‚æœç¦æ­¢åˆ·æ–°** (`skipAuthRefresh = true`)ï¼š
   - ç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸åšä»»ä½•å¤„ç†

### 2. é¿å…æ— é™å¾ªç¯ (lib/api/client.ts:183-195)

åœ¨ `apiClient.refreshToken` æ–¹æ³•ä¸­ï¼š

```typescript
async refreshToken(refreshToken: string) {
  return apiRequest<AuthResponse | ErrorResponse>(
    '/auth/token/refresh',
    { /* options */ },
    true // ğŸ”¥ è·³è¿‡ 401 è‡ªåŠ¨åˆ·æ–°ï¼Œé¿å…æ— é™å¾ªç¯
  )
}
```

**ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿ**

- `refreshToken` æœ¬èº«å¯èƒ½æ”¶åˆ° 401 å“åº”ï¼ˆrefresh token ä¹Ÿè¿‡æœŸäº†ï¼‰
- å¦‚æœä¸è·³è¿‡ 401 å¤„ç†ï¼Œä¼šå†æ¬¡è°ƒç”¨ `refreshAccessToken`
- è¿™ä¼šå½¢æˆæ— é™å¾ªç¯ï¼š`401 â†’ refresh â†’ 401 â†’ refresh â†’ ...`

## ä½¿ç”¨ç¤ºä¾‹

### æ™®é€š API è°ƒç”¨ï¼ˆè‡ªåŠ¨å¤„ç† 401ï¼‰

```typescript
// è‡ªåŠ¨å¤„ç† 401ï¼Œæ— éœ€é¢å¤–ä»£ç 
const result = await apiRequest('/api/user/profile')

// å¦‚æœ token è¿‡æœŸï¼š
// 1. è‡ªåŠ¨åˆ·æ–° token
// 2. è‡ªåŠ¨é‡è¯•è¯·æ±‚
// 3. è¿”å›æ­£ç¡®ç»“æœ
```

### è·³è¿‡ 401 å¤„ç†ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

```typescript
// åˆ·æ–° token è¯·æ±‚æœ¬èº«ä¸è§¦å‘ 401 å¤„ç†
await apiRequest('/auth/token/refresh', options, true)
```

## æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API è°ƒç”¨       â”‚
â”‚  (401 é”™è¯¯)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ skipAuthRefresh?â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
   NO        YES
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°è¯•    â”‚  â”‚ ç›´æ¥è¿”å› â”‚
â”‚ åˆ·æ–°    â”‚  â”‚ é”™è¯¯     â”‚
â”‚ token   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ·æ–°    â”‚
â”‚ æˆåŠŸ?   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
  â”Œâ”€â”€â”´â”€â”€â”
  â”‚     â”‚
 YES    NO
  â”‚     â”‚
  â–¼     â–¼
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ é‡è¯• â”‚ â”‚ è·³è½¬ â”‚
â”‚ è¯·æ±‚ â”‚ â”‚ ç™»å½• â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šAccess token è¿‡æœŸï¼ŒRefresh token æœ‰æ•ˆ

1. ç”¨æˆ·ç™»å½•åï¼Œaccess token è¿‡æœŸ
2. å‘èµ· API è¯·æ±‚ â†’ æ”¶åˆ° 401
3. è‡ªåŠ¨åˆ·æ–° token â†’ æˆåŠŸ
4. ç”¨æ–° token é‡è¯•è¯·æ±‚ â†’ æˆåŠŸè¿”å›æ•°æ®
5. âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œç»§ç»­æ­£å¸¸ä½¿ç”¨

### åœºæ™¯ 2ï¼šRefresh token ä¹Ÿè¿‡æœŸ

1. ç”¨æˆ·é•¿æœŸæœªç™»å½•ï¼Œrefresh token è¿‡æœŸ
2. å‘èµ· API è¯·æ±‚ â†’ æ”¶åˆ° 401
3. å°è¯•åˆ·æ–° token â†’ å¤±è´¥
4. è‡ªåŠ¨è·³è½¬åˆ° `/auth/login?reason=token_expired`
5. âœ… ç”¨æˆ·è¢«å¼•å¯¼åˆ°ç™»å½•é¡µé‡æ–°ç™»å½•

### åœºæ™¯ 3ï¼šæ— é™å¾ªç¯ä¿æŠ¤

1. Refresh token è¯·æ±‚æ”¶åˆ° 401
2. å› ä¸º `skipAuthRefresh=true`ï¼Œä¸ä¼šå†æ¬¡å°è¯•åˆ·æ–°
3. ç›´æ¥è¿”å›é”™è¯¯
4. âœ… é¿å…äº†æ— é™å¾ªç¯

## ç›¸å…³æ–‡ä»¶

- `lib/api/client.ts` - API å®¢æˆ·ç«¯æ ¸å¿ƒå®ç°
- `lib/tokens/refresh.ts` - Token åˆ·æ–°é€»è¾‘
- `docs/AUTH_API.md` - å®Œæ•´çš„è®¤è¯æ–‡æ¡£

## æ³¨æ„äº‹é¡¹

1. **åªå½±å“å®¢æˆ·ç«¯è¯·æ±‚**ï¼šè¿™ä¸ªæœºåˆ¶åªåœ¨æµè§ˆå™¨ä¸­æœ‰æ•ˆï¼ˆæ£€æŸ¥ `typeof window !== 'undefined'`ï¼‰
2. **ä¸ä¼šå½±å“æœåŠ¡ç«¯**ï¼šNext.js middleware (`proxy.ts`) åœ¨æœåŠ¡ç«¯è¿è¡Œï¼Œä¸å—å½±å“
3. **å¹¶å‘è¯·æ±‚å¤„ç†**ï¼š`refreshAccessToken` ä½¿ç”¨ Promise é”ï¼Œå¤šä¸ªå¹¶å‘è¯·æ±‚åªä¼šè§¦å‘ä¸€æ¬¡åˆ·æ–°
4. **æ¸…ç†æœºåˆ¶**ï¼šåˆ·æ–°å¤±è´¥æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ tokens (`TokenManager.clearTokens()`)
